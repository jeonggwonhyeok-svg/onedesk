/// Naver OAuth 로그인 서비스 (데스크톱)
/// 로컬 HTTP 서버를 사용하여 OAuth 콜백을 처리합니다.
library;

import 'dart:async';
import 'dart:io';

import 'package:flutter/material.dart';
import 'package:url_launcher/url_launcher.dart';

import 'auth_service.dart';
import 'session_service.dart';
import 'models.dart';
import '../../models/platform_model.dart';

/// Naver OAuth 로그인 결과
class NaverAuthResult {
  final bool success;
  final String? error;
  final UserInfo? userInfo;

  NaverAuthResult({
    required this.success,
    this.error,
    this.userInfo,
  });
}

/// Naver OAuth 서비스 (데스크톱)
class NaverAuthService {
  static const int _port = 57403;
  static const String _callbackPath = '/auth/';
  static const Duration _timeout = Duration(seconds: 60);

  HttpServer? _server;
  final String _baseUrl;

  NaverAuthService(this._baseUrl);

  /// Naver OAuth URL
  String get naverAuthUrl => '$_baseUrl/oauth2/authorization/naver';

  /// 콜백 URL
  String get callbackUrl => 'http://localhost:$_port$_callbackPath';

  /// Naver 로그인 시작
  Future<NaverAuthResult> login() async {
    try {
      // 1. 로컬 HTTP 서버 시작
      _server = await HttpServer.bind(InternetAddress.loopbackIPv4, _port);
      debugPrint('[NaverAuth] Local server started on port $_port');

      // 2. 브라우저에서 Naver OAuth 페이지 열기
      final uri = Uri.parse(naverAuthUrl);
      if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
        await _stopServer();
        return NaverAuthResult(
          success: false,
          error: 'Failed to open browser',
        );
      }

      // 3. 콜백 대기 (타임아웃 포함)
      final result = await _waitForCallback().timeout(
        _timeout,
        onTimeout: () {
          debugPrint('[NaverAuth] Timeout waiting for callback');
          return NaverAuthResult(
            success: false,
            error: 'Login timeout',
          );
        },
      );

      return result;
    } catch (e) {
      debugPrint('[NaverAuth] Error: $e');
      return NaverAuthResult(
        success: false,
        error: e.toString(),
      );
    } finally {
      await _stopServer();
    }
  }

  /// 콜백 대기
  Future<NaverAuthResult> _waitForCallback() async {
    final completer = Completer<NaverAuthResult>();

    _server!.listen((request) async {
      final path = request.uri.path;

      debugPrint('[NaverAuth] ========================================');
      debugPrint('[NaverAuth] 콜백 요청 수신');
      debugPrint('[NaverAuth] 전체 URI: ${request.uri}');
      debugPrint('[NaverAuth] Path: $path');
      debugPrint('[NaverAuth] Query String: ${request.uri.query}');
      debugPrint(
          '[NaverAuth] Query Parameters: ${request.uri.queryParameters}');
      debugPrint('[NaverAuth] ========================================');

      // favicon.ico 등 관계없는 요청 무시
      if (path == '/favicon.ico' || path == '/robots.txt') {
        debugPrint('[NaverAuth] 무시하는 요청: $path');
        request.response
          ..statusCode = HttpStatus.notFound
          ..close();
        return;
      }

      // lt 토큰 추출
      final lt = request.uri.queryParameters['lt'];
      final error = request.uri.queryParameters['error'];

      debugPrint('[NaverAuth] 추출된 lt: "$lt"');
      debugPrint('[NaverAuth] 추출된 error: "$error"');

      // HTML 응답 전송
      final html = '''
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Naver Login</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #fff;
        }
        .container {
            text-align: center;
            background: white;
            padding: 40px 60px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h2 {
            color: #333;
            margin-bottom: 10px;
        }
        p {
            color: #666;
            font-size: 14px;
        }
        .success { color: #03C75A; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        ${error != null ? '<h2 class="error">로그인 실패</h2><p>$error</p>' : '<h2 class="success">로그인 성공</h2><p>창을 닫아도 됩니다.</p>'}
    </div>
    <script>
        setTimeout(() => {
            try { window.close(); } catch(e) {}
        }, 2000);
    </script>
</body>
</html>
''';

      request.response
        ..statusCode = HttpStatus.ok
        ..headers.contentType = ContentType.html
        ..write(html);
      await request.response.close();

      // 에러 체크
      if (error != null) {
        if (!completer.isCompleted) {
          completer.complete(NaverAuthResult(
            success: false,
            error: error,
          ));
        }
        return;
      }

      // lt 토큰 체크
      if (lt == null || lt.isEmpty) {
        debugPrint('[NaverAuth] lt 토큰이 없음! URI: ${request.uri}');
        if (!completer.isCompleted) {
          completer.complete(NaverAuthResult(
            success: false,
            error: 'Token not received (URI: ${request.uri})',
          ));
        }
        return;
      }

      // 4. pickup API 호출
      try {
        final authService = getAuthService();
        final pickupRes = await authService.pickup(lt);

        if (!pickupRes.success) {
          if (!completer.isCompleted) {
            completer.complete(NaverAuthResult(
              success: false,
              error: 'Token authentication failed',
            ));
          }
          return;
        }

        // 5. 사용자 정보 조회
        final meRes = await authService.me();
        if (!meRes.success || meRes.data == null) {
          if (!completer.isCompleted) {
            completer.complete(NaverAuthResult(
              success: false,
              error: 'Failed to get user info',
            ));
          }
          return;
        }

        final userInfo = UserInfo.fromJson(meRes.data!);

        // 6. 세션 등록 및 활성화
        if (isSessionServiceInitialized()) {
          final sessionService = getSessionService();
          final deviceId = await bind.mainGetMyId();
          final version = await bind.mainGetVersion();

          final registerRes =
              await sessionService.registerSession(deviceId, version);
          if (registerRes.success) {
            final deviceKey = registerRes.extract('deviceKey') ?? '';
            userInfo.deviceKey = deviceKey;

            if (deviceKey.isNotEmpty) {
              // 세션 활성화 (약간의 딜레이 추가 - 서버 동기화 대기)
              await Future.delayed(const Duration(milliseconds: 500));
              final activateRes =
                  await sessionService.activateSession(deviceKey);
              if (activateRes.success) {
                userInfo.sessionKey = activateRes.extract('sessionKey');
              }
            }
          }
        }

        // loginType을 naver(3)로 설정
        userInfo.loginType = 3;

        if (!completer.isCompleted) {
          completer.complete(NaverAuthResult(
            success: true,
            userInfo: userInfo,
          ));
        }
      } catch (e) {
        debugPrint('[NaverAuth] Pickup error: $e');
        if (!completer.isCompleted) {
          completer.complete(NaverAuthResult(
            success: false,
            error: e.toString(),
          ));
        }
      }
    });

    return completer.future;
  }

  /// 서버 중지
  Future<void> _stopServer() async {
    if (_server != null) {
      await _server!.close(force: true);
      _server = null;
      debugPrint('[NaverAuth] Local server stopped');
    }
  }

  /// 로그인 취소
  Future<void> cancel() async {
    await _stopServer();
  }
}

/// 전역 NaverAuthService 인스턴스
NaverAuthService? _naverAuthService;

/// NaverAuthService 초기화
void initNaverAuthService(String baseUrl) {
  _naverAuthService = NaverAuthService(baseUrl);
}

/// NaverAuthService 가져오기
NaverAuthService getNaverAuthService() {
  if (_naverAuthService == null) {
    throw StateError(
        'NaverAuthService not initialized. Call initNaverAuthService first.');
  }
  return _naverAuthService!;
}

/// NaverAuthService 초기화 여부
bool isNaverAuthServiceInitialized() => _naverAuthService != null;
